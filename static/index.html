<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELT System - Panel de Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-title {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .card {
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title {
            font-weight: 600;
            color: #2c3e50;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .card-body {
            color: #7f8c8d;
            font-size: 14px;
        }

        .card-footer {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ecf0f1;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            flex: 1;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* Progress Bar Styles */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }

        .progress-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .progress-message {
            font-weight: 500;
            color: #2c3e50;
            flex: 1;
        }

        .progress-bar-container {
            width: 100%;
            background: #ecf0f1;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 6px;
            transition: width 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-percent {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: right;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }

        .close {
            color: #95a5a6;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #2c3e50;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
            font-family: monospace;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .form-actions button {
            flex: 1;
        }

        .table-list {
            display: grid;
            gap: 10px;
        }

        .table-item {
            padding: 15px;
            border: 1px solid #ecf0f1;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-info {
            flex: 1;
        }

        .table-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .table-description {
            font-size: 12px;
            color: #7f8c8d;
        }

        .table-fields {
            font-size: 11px;
            color: #95a5a6;
            margin-top: 5px;
        }

        .sync-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #27ae60;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .stat-card.success {
            border-left-color: #27ae60;
        }

        .stat-card.warning {
            border-left-color: #f39c12;
        }

        .stat-card.danger {
            border-left-color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîÑ Sistema ELT</h1>
            <p class="subtitle">Panel de Control y Configuraci√≥n</p>
        </header>

        <div id="alerts"></div>

        <div class="section">
            <div class="section-title">
                <span>üìä Pipelines Activos</span>
                <div>
                    <button class="btn btn-primary" onclick="runAllPipelines()">‚ñ∂Ô∏è Ejecutar Todos</button>
                    <button class="btn btn-secondary" onclick="loadData()">üîÑ Actualizar</button>
                </div>
            </div>
            <div id="pipelines" class="loading">Cargando pipelines...</div>
        </div>

        <div class="grid">
            <div class="section">
                <div class="section-title">
                    <span>üì• Fuentes de Datos</span>
                    <button class="btn btn-primary" onclick="openConfigModal()">‚öôÔ∏è Configurar</button>
                </div>
                <div id="sources" class="loading">Cargando fuentes...</div>
            </div>

            <div class="section">
                <div class="section-title">
                    <span>üì§ Destinos</span>
                    <button class="btn btn-primary" onclick="openDestinationModal()">‚öôÔ∏è Configurar</button>
                </div>
                <div id="destinations" class="loading">Cargando destinos...</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">
                <span>üìã Tablas Disponibles para Sincronizar</span>
                <div>
                    <button class="btn btn-primary" onclick="openInsightsModal()">üìä Configurar Insights</button>
                    <button class="btn btn-secondary" onclick="loadAvailableTables()">üîÑ Actualizar</button>
                </div>
            </div>
            <div id="available-tables" class="loading">Cargando tablas disponibles...</div>
        </div>

        <div class="section">
            <div class="section-title">üìä Datos Sincronizados</div>
            <div id="synced-data" class="loading">Cargando estad√≠sticas...</div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n de Fuentes -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configuraci√≥n de Facebook Ads</h2>
                <span class="close" onclick="closeConfigModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="configForm">
                    <div class="form-group">
                        <label>App ID:</label>
                        <input type="text" id="appId" placeholder="Tu Facebook App ID" required>
                    </div>
                    <div class="form-group">
                        <label>App Secret:</label>
                        <input type="password" id="appSecret" placeholder="Tu Facebook App Secret" required>
                    </div>
                    <div class="form-group">
                        <label>Access Token:</label>
                        <textarea id="accessToken" placeholder="Tu Access Token de Facebook" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Ad Account ID:</label>
                        <input type="text" id="adAccountId" placeholder="act_123456789" required>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableSource" checked>
                            Activar esta fuente
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Guardar Configuraci√≥n</button>
                        <button type="button" class="btn btn-secondary" onclick="closeConfigModal()">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n de Destinos -->
    <div id="destinationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configuraci√≥n de MySQL</h2>
                <span class="close" onclick="closeDestinationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="destinationForm">
                    <div class="form-group">
                        <label>Host:</label>
                        <input type="text" id="mysqlHost" placeholder="localhost o mysql" required>
                    </div>
                    <div class="form-group">
                        <label>Puerto:</label>
                        <input type="number" id="mysqlPort" placeholder="3306" required>
                    </div>
                    <div class="form-group">
                        <label>Usuario:</label>
                        <input type="text" id="mysqlUser" placeholder="eltuser" required>
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a:</label>
                        <input type="password" id="mysqlPassword" placeholder="Tu contrase√±a MySQL" required>
                    </div>
                    <div class="form-group">
                        <label>Base de Datos:</label>
                        <input type="text" id="mysqlDatabase" placeholder="elt_data" required>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableDestination" checked>
                            Activar este destino
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Guardar Configuraci√≥n</button>
                        <button type="button" class="btn btn-secondary" onclick="closeDestinationModal()">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n de Insights -->
    <div id="insightsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Configuraci√≥n de Insights</h2>
                <span class="close" onclick="closeInsightsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="insightsForm">
                    <div class="form-group">
                        <label>Dimensi√≥n (Nivel de Agregaci√≥n):</label>
                        <select id="insightsDimension" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="account">Nivel de Cuenta</option>
                            <option value="campaign">Por Campa√±a</option>
                            <option value="adset">Por Conjunto de Anuncios</option>
                            <option value="ad">Por Anuncio Individual</option>
                        </select>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">Selecciona c√≥mo deseas agrupar los datos</small>
                    </div>

                    <div class="form-group">
                        <label>Granularidad Temporal:</label>
                        <select id="insightsTimeIncrement" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="daily">Diario (un registro por d√≠a)</option>
                            <option value="monthly">Mensual (un registro por mes)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Rango de Fechas:</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="font-size: 12px; color: #7f8c8d;">Fecha Inicio:</label>
                                <input type="date" id="insightsStartDate">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #7f8c8d;">Fecha Fin:</label>
                                <input type="date" id="insightsEndDate">
                            </div>
                        </div>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">O especifica solo "√öltimos d√≠as":</small>
                        <input type="number" id="insightsDateRange" placeholder="30" min="1" max="365" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                    </div>

                    <div class="form-group">
                        <label>M√©tricas a Incluir:</label>
                        <small style="color: #7f8c8d; display: block; margin-bottom: 10px;">Selecciona las m√©tricas que deseas sincronizar (todas las opciones de Facebook Ads API v22.0):</small>
                        <div id="metricsCheckboxes" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #ecf0f1; border-radius: 5px; background: #f8f9fa;">
                            <!-- Ser√° llenado din√°micamente por JavaScript -->
                            <div style="grid-column: 1/-1; color: #7f8c8d; text-align: center;">Cargando m√©tricas...</div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Guardar Configuraci√≥n</button>
                        <button type="button" class="btn btn-secondary" onclick="closeInsightsModal()">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Error en la solicitud');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        function showAlert(message, type = 'success') {
            const alertsDiv = document.getElementById('alerts');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass}`;
            alert.textContent = message;
            
            alertsDiv.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        async function loadPipelines() {
            try {
                const result = await apiCall('/api/pipelines');
                const pipelines = result.data;
                
                const container = document.getElementById('pipelines');
                
                if (pipelines.length === 0) {
                    container.innerHTML = '<div class="empty-state">No hay pipelines configurados</div>';
                    return;
                }
                
                container.innerHTML = pipelines.map(pipeline => `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">${pipeline.source} ‚Üí ${pipeline.destination}</div>
                            <button class="btn btn-success" onclick="runPipeline('${pipeline.source}')">
                                ‚ñ∂Ô∏è Ejecutar
                            </button>
                        </div>
                        <div class="card-body">
                            <strong>Tipo:</strong> ${pipeline.source_type}<br>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                document.getElementById('pipelines').innerHTML = 
                    `<div class="alert alert-error">Error al cargar pipelines: ${error.message}</div>`;
            }
        }

        async function loadSources() {
            try {
                const result = await apiCall('/api/sources');
                const sources = result.data;
                
                const container = document.getElementById('sources');
                
                if (sources.length === 0) {
                    container.innerHTML = '<div class="empty-state">No hay fuentes configuradas</div>';
                    return;
                }
                
                container.innerHTML = sources.map(source => {
                    const statusClass = source.enabled ? 'badge-success' : 'badge-danger';
                    const statusText = source.enabled ? 'Activo' : 'Inactivo';
                    
                    return `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">${source.name}</div>
                                <span class="badge ${statusClass}">${statusText}</span>
                            </div>
                            <div class="card-body">
                                <strong>Tipo:</strong> ${source.type}<br>
                                <strong>Destino:</strong> ${source.destination}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                document.getElementById('sources').innerHTML = 
                    `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        async function loadDestinations() {
            try {
                const result = await apiCall('/api/destinations');
                const destinations = result.data;
                
                const container = document.getElementById('destinations');
                
                if (destinations.length === 0) {
                    container.innerHTML = '<div class="empty-state">No hay destinos configurados</div>';
                    return;
                }
                
                container.innerHTML = destinations.map(dest => {
                    const statusClass = dest.enabled ? 'badge-success' : 'badge-danger';
                    const statusText = dest.enabled ? 'Activo' : 'Inactivo';
                    
                    return `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">${dest.name}</div>
                                <span class="badge ${statusClass}">${statusText}</span>
                            </div>
                            <div class="card-body">
                                <strong>Tipo:</strong> ${dest.type}<br>
                                ${dest.config && dest.config.database ? 
                                    `<strong>Base de datos:</strong> ${dest.config.database}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                document.getElementById('destinations').innerHTML = 
                    `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        async function runPipeline(sourceName) {
            try {
                // Crear elemento de progreso
                const progressId = 'progress-' + Date.now();
                const progressHtml = `
                    <div id="${progressId}" class="progress-container">
                        <div class="progress-header">
                            <div class="spinner"></div>
                            <div class="progress-message" id="${progressId}-message">Iniciando sincronizaci√≥n...</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="${progressId}-bar" style="width: 0%"></div>
                        </div>
                        <div class="progress-percent" id="${progressId}-percent">0%</div>
                    </div>
                `;
                
                // Insertar al inicio del container
                const container = document.querySelector('.container');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = progressHtml;
                container.insertBefore(tempDiv.firstElementChild, container.firstChild);
                
                const messageEl = document.getElementById(`${progressId}-message`);
                const barEl = document.getElementById(`${progressId}-bar`);
                const percentEl = document.getElementById(`${progressId}-percent`);
                
                // Simular progreso mientras se ejecuta
                let currentProgress = 0;
                const messages = [
                    'üöÄ Iniciando sincronizaci√≥n...',
                    'üìä Conectando a Facebook Ads...',
                    'üì• Descargando datos...',
                    'üíæ Procesando informaci√≥n...',
                    'üì§ Guardando en base de datos...'
                ];
                let messageIndex = 0;
                
                const progressInterval = setInterval(() => {
                    if (currentProgress < 90) {
                        currentProgress += Math.random() * 15;
                        if (currentProgress > 90) currentProgress = 90;
                        
                        if (barEl) barEl.style.width = currentProgress + '%';
                        if (percentEl) percentEl.textContent = Math.round(currentProgress) + '%';
                        
                        // Cambiar mensaje cada 20%
                        const newMessageIndex = Math.floor(currentProgress / 20);
                        if (newMessageIndex !== messageIndex && newMessageIndex < messages.length) {
                            messageIndex = newMessageIndex;
                            if (messageEl) messageEl.textContent = messages[messageIndex];
                        }
                    }
                }, 500);
                
                try {
                    // Ejecutar pipeline
                    const result = await apiCall(`/api/pipelines/run/${sourceName}`, {
                        method: 'POST'
                    });
                    
                    clearInterval(progressInterval);
                    
                    if (result.success) {
                        // Completar progreso
                        if (barEl) barEl.style.width = '100%';
                        if (percentEl) percentEl.textContent = '100%';
                        if (messageEl) {
                            messageEl.textContent = `‚úÖ Completado: ${result.data.rows} registros en ${result.data.duration?.toFixed(1)}s`;
                            const spinner = messageEl.parentElement.querySelector('.spinner');
                            if (spinner) spinner.style.display = 'none';
                        }
                        
                        setTimeout(() => {
                            const progressEl = document.getElementById(progressId);
                            if (progressEl) {
                                progressEl.style.transition = 'opacity 0.5s';
                                progressEl.style.opacity = '0';
                                setTimeout(() => progressEl.remove(), 500);
                            }
                            showAlert('‚úÖ Sincronizaci√≥n completada: ' + result.data.rows + ' registros', 'success');
                            loadData();
                        }, 3000);
                    } else {
                        throw new Error(result.error || 'Error desconocido');
                    }
                    
                } catch (error) {
                    clearInterval(progressInterval);
                    console.error('Error:', error);
                    
                    if (messageEl) {
                        messageEl.textContent = `‚ùå Error: ${error.message}`;
                        const spinner = messageEl.parentElement.querySelector('.spinner');
                        if (spinner) spinner.style.display = 'none';
                    }
                    
                    setTimeout(() => {
                        document.getElementById(progressId)?.remove();
                        showAlert('‚ùå Error: ' + error.message, 'error');
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error in runPipeline:', error);
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        async function runAllPipelines() {
            try {
                showAlert('Ejecutando todos los pipelines...', 'success');
                
                const result = await apiCall('/api/pipelines/run', {
                    method: 'POST'
                });
                
                if (result.success) {
                    const totalRows = result.data.reduce((sum, r) => sum + (r.rows || 0), 0);
                    const successful = result.data.filter(r => r.success).length;
                    
                    showAlert(
                        `Pipelines ejecutados: ${successful}/${result.data.length} exitosos. Total de filas: ${totalRows}`,
                        'success'
                    );
                } else {
                    showAlert('Error al ejecutar pipelines', 'error');
                }
                
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        function loadData() {
            loadPipelines();
            loadSources();
            loadDestinations();
            loadAvailableTables();
            loadSyncedData();
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadData);

        // Modal functions
        function openConfigModal() {
            document.getElementById('configModal').style.display = 'block';
            loadCurrentConfig();
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
        }

        function openDestinationModal() {
            document.getElementById('destinationModal').style.display = 'block';
            loadCurrentDestinationConfig();
        }

        function closeDestinationModal() {
            document.getElementById('destinationModal').style.display = 'none';
        }

        function openInsightsModal() {
            document.getElementById('insightsModal').style.display = 'block';
            loadCurrentInsightsConfig();
        }

        function closeInsightsModal() {
            document.getElementById('insightsModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const configModal = document.getElementById('configModal');
            const destModal = document.getElementById('destinationModal');
            const insightsModal = document.getElementById('insightsModal');
            if (event.target == configModal) {
                closeConfigModal();
            }
            if (event.target == destModal) {
                closeDestinationModal();
            }
            if (event.target == insightsModal) {
                closeInsightsModal();
            }
        }

        async function loadCurrentConfig() {
            try {
                const result = await apiCall('/api/sources/facebook_ads');
                if (result.success && result.data) {
                    const config = result.data.config || {};
                    document.getElementById('appId').value = config.app_id || '';
                    document.getElementById('appSecret').value = config.app_secret || '';
                    document.getElementById('accessToken').value = config.access_token || '';
                    document.getElementById('adAccountId').value = config.ad_account_id || '';
                    document.getElementById('enableSource').checked = result.data.enabled || false;
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        async function loadCurrentDestinationConfig() {
            try {
                const result = await apiCall('/api/destinations/mysql_main');
                if (result.success && result.data) {
                    const config = result.data.config || {};
                    document.getElementById('mysqlHost').value = config.host || 'mysql';
                    document.getElementById('mysqlPort').value = config.port || 3306;
                    document.getElementById('mysqlUser').value = config.user || '';
                    document.getElementById('mysqlPassword').value = config.password || '';
                    document.getElementById('mysqlDatabase').value = config.database || 'elt_data';
                    document.getElementById('enableDestination').checked = result.data.enabled || false;
                }
            } catch (error) {
                console.error('Error loading destination config:', error);
            }
        }

        // Handle config form submission
        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const configData = {
                app_id: document.getElementById('appId').value,
                app_secret: document.getElementById('appSecret').value,
                access_token: document.getElementById('accessToken').value,
                ad_account_id: document.getElementById('adAccountId').value,
                enabled: document.getElementById('enableSource').checked
            };

            try {
                showAlert('Guardando configuraci√≥n...', 'success');
                const result = await apiCall('/api/sources/facebook_ads/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });

                if (result.success) {
                    showAlert('Configuraci√≥n guardada exitosamente', 'success');
                    closeConfigModal();
                    loadData();
                } else {
                    showAlert('Error al guardar configuraci√≥n: ' + (result.error || 'Error desconocido'), 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        // Handle destination form submission
        document.getElementById('destinationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const configData = {
                host: document.getElementById('mysqlHost').value,
                port: parseInt(document.getElementById('mysqlPort').value),
                user: document.getElementById('mysqlUser').value,
                password: document.getElementById('mysqlPassword').value,
                database: document.getElementById('mysqlDatabase').value,
                enabled: document.getElementById('enableDestination').checked
            };

            try {
                showAlert('Guardando configuraci√≥n...', 'success');
                const result = await apiCall('/api/destinations/mysql_main/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });

                if (result.success) {
                    showAlert('Configuraci√≥n guardada exitosamente', 'success');
                    closeDestinationModal();
                    loadData();
                } else {
                    showAlert('Error al guardar configuraci√≥n: ' + (result.error || 'Error desconocido'), 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        async function loadAvailableTables() {
            try {
                const result = await apiCall('/api/tables/available');
                const container = document.getElementById('available-tables');
                
                if (!result.success || !result.data || result.data.length === 0) {
                    container.innerHTML = '<div class="empty-state">No hay tablas disponibles</div>';
                    return;
                }

                container.innerHTML = '<div class="table-list">' + result.data.map(table => `
                    <div class="table-item">
                        <div class="table-info">
                            <div class="table-name">${table.name}</div>
                            <div class="table-description">${table.description || 'Tabla de datos de Facebook Ads'}</div>
                            <div class="table-fields">Campos: ${table.fields ? table.fields.join(', ') : 'N/A'}</div>
                        </div>
                        <div class="sync-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" ${table.enabled ? 'checked' : ''} 
                                    onchange="toggleTable('${table.name}', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                `).join('') + '</div>';
                
            } catch (error) {
                document.getElementById('available-tables').innerHTML = 
                    `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        async function loadSyncedData() {
            try {
                const result = await apiCall('/api/data/stats');
                const container = document.getElementById('synced-data');
                
                if (!result.success || !result.data) {
                    container.innerHTML = '<div class="empty-state">No hay datos sincronizados</div>';
                    return;
                }

                const stats = result.data;
                container.innerHTML = '<div class="data-stats">' + 
                    Object.keys(stats).map(table => {
                        const stat = stats[table];
                        return `
                            <div class="stat-card ${stat.count > 0 ? 'success' : ''}">
                                <div class="table-name">${table}</div>
                                <div class="stat-value">${stat.count || 0}</div>
                                <div class="stat-label">registros</div>
                                ${stat.last_sync ? `<div class="table-description">√öltima sync: ${new Date(stat.last_sync).toLocaleString()}</div>` : ''}
                            </div>
                        `;
                    }).join('') + 
                '</div>';
                
            } catch (error) {
                document.getElementById('synced-data').innerHTML = 
                    `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        async function toggleTable(tableName, enabled) {
            try {
                const result = await apiCall(`/api/tables/${tableName}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                if (result.success) {
                    showAlert(`Tabla '${tableName}' ${enabled ? 'activada' : 'desactivada'}`, 'success');
                } else {
                    showAlert('Error al cambiar configuraci√≥n', 'error');
                    loadAvailableTables(); // Reload to reset
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
                loadAvailableTables(); // Reload to reset
            }
        }

        async function loadCurrentInsightsConfig() {
            try {
                // Primero cargar las m√©tricas disponibles
                await loadAvailableMetrics();
                
                // Luego cargar la configuraci√≥n actual
                const result = await apiCall('/api/insights/config');
                if (result.success && result.data) {
                    const config = result.data;
                    document.getElementById('insightsDimension').value = config.level || 'account';
                    document.getElementById('insightsTimeIncrement').value = config.time_increment || 'daily';
                    document.getElementById('insightsStartDate').value = config.start_date || '';
                    document.getElementById('insightsEndDate').value = config.end_date || '';
                    document.getElementById('insightsDateRange').value = config.date_range || 30;
                    
                    // Set metrics checkboxes
                    if (config.fields && config.fields.length > 0) {
                        document.querySelectorAll('input[name="metric"]').forEach(checkbox => {
                            checkbox.checked = config.fields.includes(checkbox.value);
                        });
                    } else {
                        // Si no hay configuraci√≥n previa, seleccionar las m√©tricas b√°sicas por defecto
                        const defaultMetrics = ['impressions', 'clicks', 'spend', 'reach', 'ctr', 'cpc', 'cpm', 'frequency'];
                        document.querySelectorAll('input[name="metric"]').forEach(checkbox => {
                            checkbox.checked = defaultMetrics.includes(checkbox.value);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading insights config:', error);
            }
        }

        async function loadAvailableMetrics() {
            try {
                const result = await apiCall('/api/insights/available-fields');
                if (result.success && result.data && result.data.metrics) {
                    const metrics = result.data.metrics;
                    const container = document.getElementById('metricsCheckboxes');
                    
                    // Agrupar m√©tricas por categor√≠a
                    const groupedMetrics = {};
                    Object.entries(metrics).forEach(([key, value]) => {
                        const category = value.category || 'Otras';
                        if (!groupedMetrics[category]) {
                            groupedMetrics[category] = [];
                        }
                        groupedMetrics[category].push({ key, ...value });
                    });
                    
                    // Crear HTML agrupado
                    let html = '';
                    const categoryOrder = ['Entrega', 'Costo', 'Conversi√≥n', 'Compras', 'Leads', 'Engagement', 'Video', 'Links', 'Atribuci√≥n', 'Aplicaci√≥n', 'Org√°nico/Pagado', 'Otras'];
                    
                    categoryOrder.forEach(category => {
                        if (groupedMetrics[category]) {
                            html += `<div style="grid-column: 1/-1; font-weight: 600; color: #2c3e50; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">${category}</div>`;
                            groupedMetrics[category].forEach(metric => {
                                const defaultMetrics = ['impressions', 'clicks', 'spend', 'reach', 'ctr', 'cpc', 'cpm', 'frequency'];
                                const isChecked = defaultMetrics.includes(metric.key) ? 'checked' : '';
                                html += `<label style="font-size: 13px; display: flex; align-items: center; gap: 8px; cursor: pointer;" title="${metric.description}">
                                    <input type="checkbox" name="metric" value="${metric.key}" ${isChecked}>
                                    <span>${metric.label}</span>
                                    <span style="color: #95a5a6; font-size: 11px;">(${metric.key})</span>
                                </label>`;
                            });
                        }
                    });
                    
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading available metrics:', error);
                // Fallback to basic metrics if API fails
                const container = document.getElementById('metricsCheckboxes');
                container.innerHTML = `
                    <label><input type="checkbox" name="metric" value="impressions" checked> Impresiones</label>
                    <label><input type="checkbox" name="metric" value="clicks" checked> Clics</label>
                    <label><input type="checkbox" name="metric" value="spend" checked> Gasto</label>
                    <label><input type="checkbox" name="metric" value="reach" checked> Alcance</label>
                    <label><input type="checkbox" name="metric" value="ctr" checked> CTR (Tasa de Clics)</label>
                    <label><input type="checkbox" name="metric" value="cpc" checked> CPC (Costo por Clic)</label>
                    <label><input type="checkbox" name="metric" value="cpm" checked> CPM (Costo por Mil)</label>
                    <label><input type="checkbox" name="metric" value="frequency" checked> Frecuencia</label>
                `;
            }
        }

        // Handle insights form submission
        document.getElementById('insightsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedMetrics = Array.from(
                document.querySelectorAll('input[name="metric"]:checked')
            ).map(cb => cb.value);

            const startDate = document.getElementById('insightsStartDate').value;
            const endDate = document.getElementById('insightsEndDate').value;
            const dateRange = parseInt(document.getElementById('insightsDateRange').value) || 30;

            const configData = {
                level: document.getElementById('insightsDimension').value,
                time_increment: document.getElementById('insightsTimeIncrement').value,
                fields: selectedMetrics
            };

            // Si el usuario especifica fechas, usar esas; si no, usar date_range
            if (startDate && endDate) {
                configData.start_date = startDate;
                configData.end_date = endDate;
            } else {
                configData.date_range = dateRange;
            }

            try {
                showAlert('Guardando configuraci√≥n de insights...', 'success');
                const result = await apiCall('/api/insights/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });

                if (result.success) {
                    showAlert('Configuraci√≥n de insights guardada exitosamente', 'success');
                    closeInsightsModal();
                    loadData();
                } else {
                    showAlert('Error al guardar configuraci√≥n: ' + (result.error || 'Error desconocido'), 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
